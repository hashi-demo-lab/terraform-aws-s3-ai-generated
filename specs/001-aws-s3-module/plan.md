# Implementation Plan: Terraform AWS S3 Module

**Branch**: `001-aws-s3-module` | **Date**: 2026-01-11 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-aws-s3-module/spec.md`

---

## Summary

Implement a comprehensive Terraform AWS S3 module supporting three primary use cases: secure bucket deployment (encryption, versioning, logging, public access blocks), static website hosting with CORS support, and data lake storage with lifecycle policies. The module enforces CIS AWS Benchmark and SOC 2 compliance through security-by-default configurations.

---

## Technical Context

**Language/Version**: HCL (Terraform >= 1.5.0)
**Primary Dependencies**: AWS Provider ~> 5.0 (latest: 6.28.0)
**Storage**: AWS S3 (general purpose buckets)
**Testing**: Terraform Test Framework (native .tftest.hcl files)
**Target Platform**: AWS Cloud (all regions supporting S3)
**Project Type**: Terraform Module (single module, reusable)
**Performance Goals**: Bucket creation < 5 minutes, idempotent operations
**Constraints**: Max 50 lifecycle rules, max 10 CORS rules, globally unique bucket names
**Scale/Scope**: Single S3 bucket with associated configurations per module instance

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| 1.1 Consumer-Centric Design | PASS | Intuitive defaults, comprehensive variable descriptions, basic/complete examples planned |
| 1.2 Quality Over Speed | PASS | Full test suite (unit + integration), security scanning, pre-commit hooks |
| 1.3 Specification-Driven Development | PASS | Detailed spec.md with 30+ functional requirements, clarifications documented |
| 1.4 Backward Compatibility First | PASS | Initial release v1.0.0, semver will be followed |
| 1.5 Security by Default | PASS | Encryption enabled, public access blocked, HTTPS enforced, versioning enabled |
| 1.6 Test Everything | PASS | Unit tests for validation, integration tests for resources, compliance tests planned |
| 3.1 Module Structure | PASS | Standard directory layout with examples/, tests/, all required files |
| 4.1 Secure Defaults | PASS | AES-256 encryption, all public access blocks enabled, versioning enabled |
| 4.2 Least Privilege | PASS | KMS key policy follows least privilege, bucket policy restricts access |
| 4.3 Secrets Management | PASS | No hardcoded secrets, KMS keys managed securely |
| 6.2 Testing Requirements | PASS | Unit tests (<10s), integration tests, examples validated |

**Gate Status**: PASSED - All constitution principles satisfied.

---

## Project Structure

### Documentation (this feature)

```text
specs/001-aws-s3-module/
├── spec.md              # Feature specification
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 research findings
├── data-model.md        # Phase 1 data model
├── quickstart.md        # Phase 1 quickstart guide
├── contracts/           # Phase 1 API contracts (N/A for Terraform modules)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
terraform-aws-s3-module/
├── main.tf                          # Primary module resources
├── variables.tf                     # Input variable definitions
├── outputs.tf                       # Output value definitions
├── versions.tf                      # Terraform/provider version constraints
├── locals.tf                        # Local values and computations
├── data.tf                          # Data sources
├── README.md                        # Auto-generated documentation
├── CHANGELOG.md                     # Version history
├── LICENSE                          # MPL-2.0 license
├── .gitignore                       # Standard Terraform gitignore
├── .pre-commit-config.yaml          # Pre-commit hooks
├── .tflint.hcl                      # Linting rules
├── .terraform-docs.yml              # Documentation config
├── trivy.yaml                       # Security scanning config
├── examples/
│   ├── README.md                    # Examples overview
│   ├── basic/                       # Minimal secure bucket
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── README.md
│   ├── complete/                    # Full-featured example
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── README.md
│   └── website/                     # Static website hosting
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── README.md
├── tests/
│   ├── unit-tests.tftest.hcl        # Fast validation tests
│   ├── integration-tests.tftest.hcl # Real deployment tests
│   └── setup/                       # Test fixtures
│       ├── main.tf
│       ├── outputs.tf
│       └── versions.tf
└── .github/
    └── workflows/
        ├── module_validate.yml      # PR validation
        ├── module_publish.yml       # Publish to registry
        └── breaking_changes.yml     # Breaking change detection
```

**Structure Decision**: Standard Terraform module structure per constitution section 3.1, with three example directories covering the three primary use cases.

---

## Architecture Overview

### Resource Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          terraform-aws-s3-module                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Core Resources                               │   │
│  │                                                                      │   │
│  │   ┌─────────────────┐    ┌─────────────────────────────────────┐   │   │
│  │   │  aws_kms_key    │───▶│         aws_s3_bucket               │   │   │
│  │   │  (conditional)  │    │  - bucket name/prefix               │   │   │
│  │   └─────────────────┘    │  - tags                             │   │   │
│  │                          │  - force_destroy                    │   │   │
│  │                          └─────────────────────────────────────┘   │   │
│  │                                          │                         │   │
│  └──────────────────────────────────────────┼─────────────────────────┘   │
│                                             │                              │
│  ┌──────────────────────────────────────────┼─────────────────────────┐   │
│  │                    Configuration Resources                          │   │
│  │                                          ▼                          │   │
│  │  ┌───────────────────┐  ┌───────────────────┐  ┌────────────────┐  │   │
│  │  │ ownership_controls│  │    versioning     │  │   encryption   │  │   │
│  │  │ BucketOwnerEnforce│  │ Enabled/Suspended │  │ AES256 or KMS  │  │   │
│  │  └───────────────────┘  └───────────────────┘  └────────────────┘  │   │
│  │                                  │                                  │   │
│  │  ┌───────────────────┐          │             ┌────────────────┐  │   │
│  │  │ public_access_bloc│          ▼             │    logging     │  │   │
│  │  │ block_public_*    │  ┌───────────────────┐ │ (conditional)  │  │   │
│  │  └───────────────────┘  │lifecycle_config   │ └────────────────┘  │   │
│  │          │              │ (conditional)     │                      │   │
│  │          │              └───────────────────┘                      │   │
│  │          ▼                                                         │   │
│  │  ┌───────────────────┐  ┌───────────────────┐  ┌────────────────┐  │   │
│  │  │  bucket_policy    │  │ website_config    │  │ cors_config    │  │   │
│  │  │ HTTPS enforcement │  │ (conditional)     │  │ (conditional)  │  │   │
│  │  │ + custom policy   │  └───────────────────┘  └────────────────┘  │   │
│  │  │ + website policy  │                                             │   │
│  │  └───────────────────┘                                             │   │
│  │                                                                    │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Resource Dependency Graph

```
                     aws_kms_key.this[0]
                     (encryption_type == "KMS" && kms_key_arn == null)
                            │
                            ▼
                     aws_s3_bucket.this
                            │
        ┌───────────────────┼───────────────────┬───────────────────┐
        │                   │                   │                   │
        ▼                   ▼                   ▼                   ▼
aws_s3_bucket_      aws_s3_bucket_      aws_s3_bucket_      aws_s3_bucket_
ownership_controls  versioning          server_side_        public_access_
.this               .this               encryption_config   block.this
                           │            .this                      │
                           │                                       │
                           ▼                                       │
               aws_s3_bucket_lifecycle_                            │
               configuration.this[0]                               │
               (length(lifecycle_rules) > 0)                       │
                           │                                       │
                           ▼                                       ▼
        ┌──────────────────┼──────────────────────────────────────┐
        │                  │                                       │
        ▼                  ▼                                       ▼
aws_s3_bucket_      aws_s3_bucket_                          aws_s3_bucket_
logging.this[0]     website_config                          policy.this
(enable_logging)    .this[0]                                (always - HTTPS
                    (enable_website)                         enforcement)
                           │
                           ▼
               aws_s3_bucket_cors_
               configuration.this[0]
               (length(cors_rules) > 0)
```

---

## Implementation Phases

### Phase 1: Core Infrastructure (Priority P1 - Secure Bucket)

**Objective**: Implement secure-by-default S3 bucket with encryption, versioning, and public access blocks.

**Resources**:
1. `aws_kms_key` (conditional) - KMS key for SSE-KMS encryption
2. `aws_s3_bucket` - Core bucket resource
3. `aws_s3_bucket_ownership_controls` - Enforce BucketOwnerEnforced
4. `aws_s3_bucket_versioning` - Enable versioning by default
5. `aws_s3_bucket_server_side_encryption_configuration` - AES256/KMS encryption
6. `aws_s3_bucket_public_access_block` - Block all public access by default
7. `aws_s3_bucket_policy` - Enforce HTTPS via SecureTransport condition

**Deliverables**:
- `main.tf` with core resources
- `variables.tf` with bucket, versioning, encryption, public access variables
- `outputs.tf` with bucket identifiers and endpoints
- `versions.tf` with Terraform/provider constraints
- `locals.tf` with computed values
- `data.tf` with data sources
- Unit tests for variable validation
- Basic example (`examples/basic/`)

**Acceptance Criteria**:
- Bucket created with AES-256 encryption by default
- Versioning enabled by default
- All four public access blocks enabled
- HTTPS enforced via bucket policy
- `terraform validate` passes
- Unit tests pass

### Phase 2: Extended Features (Priority P2/P3)

**Objective**: Implement logging, lifecycle policies, website hosting, and CORS.

**Resources**:
1. `aws_s3_bucket_logging` (conditional) - Server access logging
2. `aws_s3_bucket_lifecycle_configuration` (conditional) - Lifecycle rules
3. `aws_s3_bucket_website_configuration` (conditional) - Static website hosting
4. `aws_s3_bucket_cors_configuration` (conditional) - CORS rules

**Deliverables**:
- Extended `main.tf` with conditional resources
- Extended `variables.tf` with logging, lifecycle, website, CORS variables
- Extended `outputs.tf` with website endpoints
- Complete example (`examples/complete/`)
- Website example (`examples/website/`)
- Integration tests for all features

**Acceptance Criteria**:
- Logging configurable with target bucket validation
- Lifecycle rules support all storage class transitions
- Website hosting with automatic public access adjustment
- CORS rules configurable up to 10 rules
- All integration tests pass

### Phase 3: Testing and Documentation

**Objective**: Complete test suite and documentation for publication.

**Deliverables**:
- `tests/unit-tests.tftest.hcl` - All variable validation tests
- `tests/integration-tests.tftest.hcl` - Resource creation tests
- `README.md` - Auto-generated via terraform-docs
- `CHANGELOG.md` - Initial version history
- `.pre-commit-config.yaml` - Pre-commit hooks
- `.tflint.hcl` - Linting configuration
- `trivy.yaml` - Security scanning configuration
- `.github/workflows/` - CI/CD pipelines

**Acceptance Criteria**:
- All unit tests pass in < 10 seconds
- All integration tests pass
- `terraform fmt -check` passes
- TFLint passes with no errors
- Trivy security scan passes
- terraform-docs generates complete README

---

## Risk Assessment

### High Risk

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Bucket name collision | Medium | High | Use bucket_prefix with random suffix; clear error messages |
| KMS key permission errors | Medium | High | Comprehensive key policy; validate IAM permissions |
| Website/public access conflict | Low | High | Automatic public access block adjustment; validation |

### Medium Risk

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Logging target bucket not found | Medium | Medium | Data source validation; clear error message |
| Lifecycle rule limit exceeded | Low | Medium | Variable validation (max 50 rules) |
| Provider version incompatibility | Low | Medium | Lock provider version ~> 5.0 |

### Low Risk

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| State drift from console changes | Low | Low | Documentation; drift detection in CI |
| Cross-region storage class issues | Low | Low | Documentation of region limitations |

---

## Testing Strategy

### Unit Tests (tests/unit-tests.tftest.hcl)

**Purpose**: Validate variable validation, conditional logic, defaults
**Execution Time**: < 10 seconds
**Command**: `plan` (no resources created)

| Test Case | Description | Expected |
|-----------|-------------|----------|
| `invalid_bucket_name_rejected` | Invalid bucket name format | expect_failures |
| `valid_bucket_name_accepted` | Valid bucket name | No errors |
| `invalid_encryption_type_rejected` | Invalid encryption type | expect_failures |
| `invalid_kms_deletion_window_rejected` | KMS window < 7 or > 30 | expect_failures |
| `lifecycle_rules_max_exceeded` | > 50 lifecycle rules | expect_failures |
| `cors_rules_max_exceeded` | > 10 CORS rules | expect_failures |
| `invalid_environment_rejected` | Invalid environment value | expect_failures |
| `default_values_applied` | Check default encryption, versioning | Assertions pass |
| `kms_key_created_when_kms_selected` | KMS encryption selected | KMS key in plan |
| `website_public_access_adjusted` | Website enabled | Public access blocks adjusted |

### Integration Tests (tests/integration-tests.tftest.hcl)

**Purpose**: Validate actual resource creation and behavior
**Execution Time**: 5-10 minutes
**Command**: `apply` (creates real resources)

| Test Case | Description | Expected |
|-----------|-------------|----------|
| `basic_bucket_creation` | Create bucket with defaults | All security defaults applied |
| `kms_encryption_bucket` | Create bucket with KMS encryption | KMS key created, encryption configured |
| `website_bucket_creation` | Create website-enabled bucket | Website endpoint accessible |
| `lifecycle_rules_applied` | Create bucket with lifecycle rules | Rules configured correctly |
| `logging_configuration` | Create bucket with logging | Logging configured to target bucket |

### Compliance Tests

| Framework | Control | Test |
|-----------|---------|------|
| CIS AWS 2.1.1 | HTTPS enforcement | Verify bucket policy denies non-HTTPS |
| CIS AWS 2.1.4 | Public access blocks | Verify all four blocks enabled by default |
| CIS AWS 2.1.5 | KMS encryption | Verify KMS option with key rotation |
| SOC 2 CC6.1 | Access controls | Verify public access blocks, policies |
| SOC 2 CC6.6 | Encryption | Verify encryption at rest and in transit |

---

## Dependencies

### External Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| Terraform | >= 1.5.0 | Infrastructure as Code |
| AWS Provider | ~> 5.0 | AWS resource management |
| Random Provider | ~> 3.0 | Random suffix for bucket_prefix |

### Internal Dependencies

| Resource | Depends On | Reason |
|----------|------------|--------|
| `aws_s3_bucket_lifecycle_configuration` | `aws_s3_bucket_versioning` | Noncurrent version rules require versioning |
| `aws_s3_bucket_policy` | `aws_s3_bucket_public_access_block` | Policy may conflict with blocks |
| `aws_s3_bucket_server_side_encryption_configuration` | `aws_kms_key` | KMS key must exist first |

---

## Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Deployment time | < 5 minutes | Time from apply to complete |
| Unit test execution | < 10 seconds | Test run time |
| Idempotency | 100% | No changes on repeated apply |
| CIS compliance | 100% | All applicable controls pass |
| Code coverage | All paths | All conditional branches tested |
| Documentation | Complete | All variables/outputs documented |

---

## Next Steps

1. Run `/speckit.tasks` to generate detailed task breakdown
2. Run `/speckit.analyze` to validate cross-artifact consistency
3. Run `/speckit.implement` to begin code generation
4. Complete sandbox testing before PR creation

---

## Implementation Details

### Bucket Policy Composition Strategy

The module creates a composite bucket policy that merges multiple policy requirements:

1. **HTTPS Enforcement Policy** (Always applied)
   - Denies all S3 actions when `aws:SecureTransport` is `false`
   - Applied to bucket ARN and all objects (`/*`)

2. **Website Public Read Policy** (Conditional: `enable_website == true`)
   - Allows `s3:GetObject` for all principals
   - Applied only to objects (`/*`), not bucket-level operations

3. **Custom Policy** (Conditional: `bucket_policy != null`)
   - User-provided policy statements merged with above
   - Validated as proper JSON before apply

**Policy Merge Order**:
```hcl
data "aws_iam_policy_document" "combined" {
  source_policy_documents = compact([
    data.aws_iam_policy_document.require_https.json,
    var.enable_website ? data.aws_iam_policy_document.website_public.json : null,
    var.bucket_policy
  ])
}
```

### Website and Public Access Block Interaction

When `enable_website = true`, the module automatically adjusts public access block settings:

| Setting | Default | With Website |
|---------|---------|--------------|
| `block_public_acls` | `true` | `true` (unchanged) |
| `ignore_public_acls` | `true` | `true` (unchanged) |
| `block_public_policy` | `true` | `false` (relaxed) |
| `restrict_public_buckets` | `true` | `false` (relaxed) |

This ensures:
- ACL-based public access remains blocked (security)
- Policy-based public access is allowed for website content only
- The bucket policy explicitly controls what is publicly accessible

### Conditional Resource Creation

| Resource | Condition | Count Expression |
|----------|-----------|------------------|
| `aws_kms_key` | KMS encryption without existing key | `var.encryption_type == "KMS" && var.kms_key_arn == null ? 1 : 0` |
| `aws_s3_bucket_logging` | Logging enabled | `var.enable_logging ? 1 : 0` |
| `aws_s3_bucket_lifecycle_configuration` | Lifecycle rules provided | `length(var.lifecycle_rules) > 0 ? 1 : 0` |
| `aws_s3_bucket_website_configuration` | Website enabled | `var.enable_website ? 1 : 0` |
| `aws_s3_bucket_cors_configuration` | CORS rules provided | `length(var.cors_rules) > 0 ? 1 : 0` |

---

## Appendix: Compliance Mapping Reference

### CIS AWS Foundations Benchmark v1.5.0

| Control | Requirement | Implementation |
|---------|-------------|----------------|
| 2.1.1 | Deny HTTP requests | Bucket policy with aws:SecureTransport condition |
| 2.1.2 | MFA delete (optional) | `enable_mfa_delete` variable |
| 2.1.4 | Block public access | All four settings enabled by default |
| 2.1.5 | KMS encryption | Optional SSE-KMS with dedicated key |

### SOC 2 Trust Service Criteria

| Control | Category | Implementation |
|---------|----------|----------------|
| CC6.1 | Security | Public access blocks, bucket policies |
| CC6.6 | Security | Encryption at rest (AES256/KMS), in transit (HTTPS) |
| CC6.7 | Security | Access controls, KMS key policies |
| CC7.2 | Security | Server access logging |
| CC7.4 | Security | Versioning for recovery |
| A1.2 | Availability | Versioning, lifecycle management |
| PI1.4 | Processing Integrity | Versioning for data integrity |
